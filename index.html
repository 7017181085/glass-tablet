<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    h2 { margin: 6px 0; }
    button { font-size:18px; padding:12px 14px; width:100%; margin: 6px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top:12px; }
    .muted { color:#666; }
    .big { font-size:20px; font-weight:700; }
    input { font-size:18px; padding:12px; width:100%; box-sizing:border-box; margin-top:8px; }
    #reader { width:100%; border-radius:12px; overflow:hidden; margin-top:10px; }
    .row { display:flex; gap:10px; margin-top:8px; }
    .row button { width: 40%; }
    .row input { width: 60%; margin-top:0; }
  </style>
</head>
<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">–ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ ‚Üí —á–µ—Ä—Ç—ë–∂ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnStop" style="display:none;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <div id="reader" style="display:none;"></div>

  <div class="card">
    <div class="muted">–ï—Å–ª–∏ —Å–∫–∞–Ω –Ω–µ –ª–æ–≤–∏—Ç ‚Äî –≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</div>
    <div class="row">
      <input id="manual" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 0000140012" />
      <button id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="out"></div>

  <!-- –ù–∞–¥—ë–∂–Ω–∞—è –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ (–±–µ–∑ module) -->
  <script src="https://unpkg.com/html5-qrcode@2.3.10/minified/html5-qrcode.min.js"></script>

  <script>
    // ====== –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ======
    const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vgoMuq7bXzlt25n3PIfmWg_MnTr9JgZ";

    const headers = {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    };

    const out = document.getElementById("out");
    const readerEl = document.getElementById("reader");
    const btnScan = document.getElementById("btnScan");
    const btnStop = document.getElementById("btnStop");
    const manual = document.getElementById("manual");
    const btnOpen = document.getElementById("btnOpen");

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(title, text){
      out.innerHTML = `<div class="card"><div class="big">${esc(title)}</div><div class="muted" style="margin-top:8px;">${esc(text)}</div></div>`;
    }

    async function supaGet(path){
      const r = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function openDrawingByBarcode(barcode){
      show("–ü–æ–∏—Å–∫‚Ä¶", "–®—Ç—Ä–∏—Ö–∫–æ–¥: " + barcode);

      // 1) pieces -> order_number
      const p = await supaGet(`pieces?select=order_number&barcode=eq.${encodeURIComponent(barcode)}&limit=1`);
      if(!p.length){
        show("–ù–µ –Ω–∞–π–¥–µ–Ω–æ", "–®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ pieces");
        return;
      }
      const orderNumber = String(p[0].order_number);

      // 2) order_attachments -> file_url (–±–µ—Ä—ë–º —Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
      const a = await supaGet(
        `order_attachments?select=file_url,uploaded_at&order_number=eq.${encodeURIComponent(orderNumber)}&order=uploaded_at.desc&limit=1`
      );
      if(!a.length || !a[0].file_url){
        show("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞", "–î–ª—è –∑–∞–∫–∞–∑–∞ " + orderNumber + " –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ PDF/—Ñ–æ—Ç–æ");
        return;
      }

      // 3) –æ—Ç–∫—Ä—ã—Ç—å
      window.location.href = a[0].file_url;
    }

    // ====== –°–ö–ê–ù–ï–† ======
    let html5Qr = null;
    let scanning = false;

    async function startScan(){
      if (scanning) return;

      // –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ –±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —Ä–µ–∞–ª—å–Ω–æ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å
      if (typeof Html5Qrcode === "undefined"){
        show("–û—à–∏–±–∫–∞", "–°–∫–∞–Ω–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (Html5Qrcode undefined). –ü–æ–ø—Ä–æ–±—É–π –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É –∏–ª–∏ –ø—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.");
        return;
      }

      scanning = true;
      btnScan.style.display = "none";
      btnStop.style.display = "block";
      readerEl.style.display = "block";
      show("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥‚Ä¶");

      html5Qr = new Html5Qrcode("reader");

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 }, // —Ä–∞–º–∫–∞ –ø–æ–º–æ–≥–∞–µ—Ç —Ñ–æ–∫—É—Å—É
        formatsToSupport: [
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.QR_CODE
        ]
      };

      try{
        await html5Qr.start(
          { facingMode: "environment" },
          config,
          async (decodedText) => {
            // –£—Å–ø–µ—à–Ω–æ —Å—á–∏—Ç–∞–ª–∏
            await stopScan();
            await openDrawingByBarcode(String(decodedText).trim());
          },
          () => {} // –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º (–ø—Ä–æ—Å—Ç–æ –Ω–µ –Ω–∞–π–¥–µ–Ω –∫–æ–¥)
        );
      } catch(e){
        scanning = false;
        btnScan.style.display = "block";
        btnStop.style.display = "none";
        readerEl.style.display = "none";
        show("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã", String(e && e.message ? e.message : e));
      }
    }

    async function stopScan(){
      if (!scanning) return;
      scanning = false;

      try{
        if (html5Qr) {
          await html5Qr.stop();
          await html5Qr.clear();
        }
      } catch {}
      html5Qr = null;

      btnScan.style.display = "block";
      btnStop.style.display = "none";
      readerEl.style.display = "none";
    }

    btnScan.addEventListener("click", startScan);
    btnStop.addEventListener("click", stopScan);

    btnOpen.addEventListener("click", async () => {
      const code = manual.value.trim();
      if (code) await openDrawingByBarcode(code);
    });

    manual.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const code = manual.value.trim();
        if (code) await openDrawingByBarcode(code);
      }
    });
  </script>
</body>
</html>

<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    h2 { margin: 6px 0; }
    button { font-size:18px; padding:12px 14px; width:100%; margin: 6px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top:12px; }
    .muted { color:#666; }
    .big { font-size:20px; font-weight:700; }
    input { font-size:18px; padding:12px; width:100%; box-sizing:border-box; margin-top:8px; }
    video { width:100%; border-radius:12px; background:#000; margin-top:10px; display:none; }
    .row { display:flex; gap:10px; margin-top:8px; }
    .row button { width: 40%; }
    .row input { width: 60%; margin-top:0; }
    .mono { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">–ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ ‚Üí —á–µ—Ä—Ç—ë–∂ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnStop" style="display:none;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <video id="preview" autoplay playsinline></video>

  <div class="card">
    <div class="muted">–ï—Å–ª–∏ —Å–∫–∞–Ω –Ω–µ –ª–æ–≤–∏—Ç ‚Äî –≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</div>
    <div class="row">
      <input id="manual" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 0000140012" />
      <button id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="out"></div>

  <script>
    // ====== –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ======
    const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vgoMuq7bXzlt25n3PIfmWg_MnTr9JgZ";
    const headers = {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    };

    const out = document.getElementById("out");
    const video = document.getElementById("preview");
    const btnScan = document.getElementById("btnScan");
    const btnStop = document.getElementById("btnStop");
    const manual = document.getElementById("manual");
    const btnOpen = document.getElementById("btnOpen");

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(title, text){
      out.innerHTML = `
        <div class="card">
          <div class="big">${esc(title)}</div>
          <div class="mono muted" style="margin-top:8px;">${esc(text)}</div>
        </div>`;
    }

    async function supaGet(path){
      const r = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    // ====== "–£–ú–ù–´–ô" –ù–û–†–ú–ê–õ–ò–ó–ê–¢–û–† –®–¢–†–ò–•–ö–û–î–ê ======
    function buildCandidates(raw){
      const scanned = String(raw || "");
      const candidates = [];
      candidates.push(scanned);
      candidates.push(scanned.trim());
      candidates.push(scanned.replace(/\*/g, "").trim());   // –¥–ª—è CODE39
      candidates.push(scanned.replace(/\s+/g, ""));         // —É–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã

      const digits = scanned.replace(/\D/g, "");
      if (digits) candidates.push(digits);

      const noLeadZeros = digits ? digits.replace(/^0+/, "") : "";
      if (noLeadZeros) {
        candidates.push(noLeadZeros);
        candidates.push(noLeadZeros.padStart(10, "0"));
        candidates.push(noLeadZeros.padStart(12, "0"));
        candidates.push(noLeadZeros.padStart(14, "0"));
      }

      return [...new Set(candidates)].filter(Boolean);
    }

    async function openDrawingByBarcode(raw){
      const scanned = String(raw || "");
      const uniq = buildCandidates(scanned);

      show("–ü–æ–∏—Å–∫‚Ä¶",
        "–°–∫–∞–Ω–µ—Ä –ø—Ä–æ—á–∏—Ç–∞–ª:\n" + scanned +
        "\n\n–ü—Ä–æ–±—É—é –≤–∞—Ä–∏–∞–Ω—Ç—ã:\n" + uniq.join("\n")
      );

      let orderNumber = null;
      let usedBarcode = null;

      for (const code of uniq) {
        const p = await supaGet(
          `pieces?select=order_number,barcode&barcode=eq.${encodeURIComponent(code)}&limit=1`
        );
        if (p.length) {
          orderNumber = String(p[0].order_number);
          usedBarcode = code;
          break;
        }
      }

      if (!orderNumber) {
        show("–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
          "–®—Ç—Ä–∏—Ö–∫–æ–¥ –ù–ï –Ω–∞–π–¥–µ–Ω –≤ pieces.\n\n–°–∫–∞–Ω–µ—Ä –ø—Ä–æ—á–∏—Ç–∞–ª:\n" + scanned +
          "\n\n–ü—Ä–æ–±–æ–≤–∞–ª –≤–∞—Ä–∏–∞–Ω—Ç—ã:\n" + uniq.join("\n")
        );
        return;
      }

      const a = await supaGet(
        `order_attachments?select=file_url,uploaded_at&order_number=eq.${encodeURIComponent(orderNumber)}&order=uploaded_at.desc&limit=1`
      );

      if(!a.length || !a[0].file_url){
        show("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞",
          "–ù–∞—à—ë–ª –ø–æ –®–ö: " + usedBarcode + "\n–ó–∞–∫–∞–∑: " + orderNumber +
          "\n\n–ù–æ PDF/—Ñ–æ—Ç–æ –ø–æ —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
        );
        return;
      }

      show("–û—Ç–∫—Ä—ã–≤–∞—é‚Ä¶", "–ó–∞–∫–∞–∑: " + orderNumber + "\n–§–∞–π–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è‚Ä¶");
      window.location.href = a[0].file_url;
    }

    // ====== –°–ö–ê–ù–ï–† –ë–ï–ó –ë–ò–ë–õ–ò–û–¢–ï–ö (BarcodeDetector) ======
    let stream = null;
    let detector = null;
    let running = false;

    async function startScan(){
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏
      if (!("BarcodeDetector" in window)) {
        show("–°–∫–∞–Ω–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω",
          "–í —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ –Ω–µ—Ç BarcodeDetector.\n" +
          "–û—Ç–∫—Ä–æ–π –∏–º–µ–Ω–Ω–æ –≤ Google Chrome –∏ –æ–±–Ω–æ–≤–∏ Chrome.\n\n" +
          "–†—É—á–Ω–æ–π –≤–≤–æ–¥ –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤—Å–µ–≥–¥–∞."
        );
        return;
      }

      btnScan.style.display = "none";
      btnStop.style.display = "block";
      video.style.display = "block";

      try {
        detector = new BarcodeDetector({ formats: ["code_128","ean_13","ean_8","code_39","qr_code"] });
        stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
        video.srcObject = stream;
        running = true;

        show("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥‚Ä¶");

        const loop = async () => {
          if (!running) return;
          try {
            const codes = await detector.detect(video);
            if (codes && codes.length) {
              const code = (codes[0].rawValue || "").trim();
              if (code) {
                await stopScan();
                await openDrawingByBarcode(code);
                return;
              }
            }
          } catch (e) {
            // –∏–Ω–æ–≥–¥–∞ detect –º–æ–∂–µ—Ç –ø–∞–¥–∞—Ç—å –Ω–∞ –Ω–µ–∫–æ—Ç–æ—Ä—ã—Ö –¥–µ–≤–∞–π—Å–∞—Ö
            show("–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞", String(e && e.message ? e.message : e));
          }
          requestAnimationFrame(loop);
        };
        requestAnimationFrame(loop);

      } catch (e) {
        await stopScan();
        show("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã", String(e && e.message ? e.message : e));
      }
    }

    async function stopScan(){
      running = false;
      if (stream) {
        stream.getTracks().forEach(t => t.stop());
        stream = null;
      }
      video.srcObject = null;
      video.style.display = "none";
      btnScan.style.display = "block";
      btnStop.style.display = "none";
    }

    btnScan.addEventListener("click", startScan);
    btnStop.addEventListener("click", stopScan);

    btnOpen.addEventListener("click", async () => {
      const code = manual.value.trim();
      if (code) await openDrawingByBarcode(code);
    });

    manual.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const code = manual.value.trim();
        if (code) await openDrawingByBarcode(code);
      }
    });

    show("–ì–æ—Ç–æ–≤–æ", "–†—É—á–Ω–æ–π –≤–≤–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù.");
  </script>
</body>
</html>

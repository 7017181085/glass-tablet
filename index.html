<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    h2 { margin: 6px 0; }
    button { font-size:18px; padding:12px 14px; width:100%; margin: 6px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top:12px; }
    .muted { color:#666; }
    .big { font-size:20px; font-weight:700; }
    input { font-size:18px; padding:12px; width:100%; box-sizing:border-box; margin-top:8px; }
    #reader, #preview { width:100%; border-radius:12px; overflow:hidden; margin-top:10px; background:#000; }
    #preview { display:none; }
    .row { display:flex; gap:10px; margin-top:8px; }
    .row button { width: 40%; }
    .row input { width: 60%; margin-top:0; }
    .log { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">–ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ ‚Üí —á–µ—Ä—Ç—ë–∂ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnStop" style="display:none;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <!-- –î–ª—è BarcodeDetector -->
  <video id="preview" autoplay playsinline></video>

  <!-- –î–ª—è html5-qrcode -->
  <div id="reader" style="display:none;"></div>

  <div class="card">
    <div class="muted">–ï—Å–ª–∏ —Å–∫–∞–Ω –Ω–µ –ª–æ–≤–∏—Ç ‚Äî –≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</div>
    <div class="row">
      <input id="manual" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 0000140012" />
      <button id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="out"></div>

  <!-- –°–∫–∞–Ω–µ—Ä-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —á–µ—Ä–µ–∑ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π CDN -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <script>
    // ====== –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ======
    const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vgoMuq7bXzlt25n3PIfmWg_MnTr9JgZ";

    const headers = {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    };

    const out = document.getElementById("out");
    const readerEl = document.getElementById("reader");
    const video = document.getElementById("preview");
    const btnScan = document.getElementById("btnScan");
    const btnStop = document.getElementById("btnStop");
    const manual = document.getElementById("manual");
    const btnOpen = document.getElementById("btnOpen");

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(title, text){
      out.innerHTML = `<div class="card"><div class="big">${esc(title)}</div><div class="muted" style="margin-top:8px;">${esc(text)}</div></div>`;
    }
    function log(text){
      out.innerHTML = `<div class="card"><div class="big">–õ–æ–≥</div><div class="log">${esc(text)}</div></div>`;
    }

    // –ü–æ–∫–∞–∑–∞—Ç—å –ª—é–±—ã–µ –æ—à–∏–±–∫–∏ –Ω–∞ —ç–∫—Ä–∞–Ω–µ
    window.onerror = function(message, source, lineno, colno, error){
      show("JS –æ—à–∏–±–∫–∞", `${message}\n${source}:${lineno}:${colno}`);
    };

    show("–ì–æ—Ç–æ–≤–æ", "JS –∑–∞–≥—Ä—É–∑–∏–ª—Å—è. –ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù.");

    async function supaGet(path){
      const r = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function openDrawingByBarcode(barcode){
      show("–ü–æ–∏—Å–∫‚Ä¶", "–®—Ç—Ä–∏—Ö–∫–æ–¥: " + barcode);

      const p = await supaGet(`pieces?select=order_number&barcode=eq.${encodeURIComponent(barcode)}&limit=1`);
      if(!p.length){
        show("–ù–µ –Ω–∞–π–¥–µ–Ω–æ", "–®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Ç–∞–±–ª–∏—Ü–µ pieces");
        return;
      }
      const orderNumber = String(p[0].order_number);

      const a = await supaGet(
        `order_attachments?select=file_url,uploaded_at&order_number=eq.${encodeURIComponent(orderNumber)}&order=uploaded_at.desc&limit=1`
      );

      if(!a.length || !a[0].file_url){
        show("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞", "–î–ª—è –∑–∞–∫–∞–∑–∞ " + orderNumber + " –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ PDF/—Ñ–æ—Ç–æ");
        return;
      }

      window.location.href = a[0].file_url;
    }

    // ====== –°–ö–ê–ù–ï–†: –≤–∞—Ä–∏–∞–Ω—Ç 1 (BarcodeDetector) ======
    let bdStream = null;
    let bdDetector = null;
    let bdRunning = false;

    async function startBarcodeDetector(){
      log("–ö–Ω–æ–ø–∫–∞ –Ω–∞–∂–∞—Ç–∞ ‚Üí –ø—Ä–æ–±—É—é BarcodeDetector‚Ä¶");

      if (!("BarcodeDetector" in window)) {
        log("BarcodeDetector –ù–ï –¥–æ—Å—Ç—É–ø–µ–Ω ‚Üí –ø–µ—Ä–µ–π–¥—É –Ω–∞ html5-qrcode");
        return false;
      }

      bdDetector = new BarcodeDetector({ formats: ["code_128","ean_13","ean_8","code_39","qr_code"] });

      bdStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
      video.srcObject = bdStream;
      video.style.display = "block";
      readerEl.style.display = "none";

      bdRunning = true;

      const tick = async () => {
        if (!bdRunning) return;
        try {
          const codes = await bdDetector.detect(video);
          if (codes && codes.length) {
            const code = (codes[0].rawValue || "").trim();
            if (code) {
              await stopScanAll();
              await openDrawingByBarcode(code);
              return;
            }
          }
        } catch (e) {
          log("BarcodeDetector detect error: " + (e.message || e));
        }
        requestAnimationFrame(tick);
      };
      requestAnimationFrame(tick);

      log("BarcodeDetector —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª. –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥.");
      return true;
    }

    // ====== –°–ö–ê–ù–ï–†: –≤–∞—Ä–∏–∞–Ω—Ç 2 (html5-qrcode) ======
    let html5Qr = null;
    let h5Running = false;

    async function startHtml5Qrcode(){
      log("–ü—Ä–æ–±—É—é html5-qrcode‚Ä¶");

      if (typeof Html5Qrcode === "undefined") {
        show("–û—à–∏–±–∫–∞", "Html5Qrcode undefined. –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª–∞—Å—å (–ø—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç/—Ñ–∏–ª—å—Ç—Ä—ã).");
        return;
      }

      readerEl.style.display = "block";
      video.style.display = "none";

      html5Qr = new Html5Qrcode("reader");
      h5Running = true;

      const config = {
        fps: 15,
        qrbox: { width: 320, height: 320 },
        formatsToSupport: [
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.QR_CODE
        ]
      };

      await html5Qr.start(
        { facingMode: "environment" },
        config,
        async (decodedText) => {
          const code = String(decodedText || "").trim();
          if (!code) return;
          await stopScanAll();
          await openDrawingByBarcode(code);
        },
        () => {}
      );

      log("html5-qrcode —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª. –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥.");
    }

    async function stopScanAll(){
      // stop BarcodeDetector
      bdRunning = false;
      if (bdStream) { bdStream.getTracks().forEach(t => t.stop()); bdStream = null; }
      video.srcObject = null;
      video.style.display = "none";

      // stop html5-qrcode
      if (h5Running && html5Qr) {
        try { await html5Qr.stop(); } catch {}
        try { await html5Qr.clear(); } catch {}
      }
      html5Qr = null;
      h5Running = false;

      btnScan.style.display = "block";
      btnStop.style.display = "none";
      readerEl.style.display = "none";
    }

    async function startScan(){
      // –í–ê–ñ–ù–û: —á—Ç–æ–±—ã —Ç–æ—á–Ω–æ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –∫–ª–∏–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç
      btnScan.disabled = true;
      setTimeout(()=>btnScan.disabled=false, 500);

      btnScan.style.display = "none";
      btnStop.style.display = "block";

      try {
        const started = await startBarcodeDetector();
        if (!started) {
          await startHtml5Qrcode();
        }
      } catch (e) {
        await stopScanAll();
        show("–û—à–∏–±–∫–∞ —Å—Ç–∞—Ä—Ç–∞", String(e.message || e));
      }
    }

    btnScan.addEventListener("click", startScan);
    btnStop.addEventListener("click", stopScanAll);

    btnOpen.addEventListener("click", async () => {
      const code = manual.value.trim();
      if (code) await openDrawingByBarcode(code);
    });

    manual.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const code = manual.value.trim();
        if (code) await openDrawingByBarcode(code);
      }
    });
  </script>
</body>
</html>

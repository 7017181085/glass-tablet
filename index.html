<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–ª–∞–Ω—à–µ—Ç ‚Äî —á–µ—Ä—Ç—ë–∂ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    button { font-size:18px; padding:12px 14px; width: 100%; margin: 6px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top:12px; }
    .muted { color:#666; }
    #preview { width:100%; border-radius:12px; margin-top:12px; display:none; }
  </style>
</head>
<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">–°–∫–∞–Ω–∏—Ä—É–π —à—Ç—Ä–∏—Ö–∫–æ–¥ —Å—Ç–µ–∫–ª–∞ ‚Üí —á–µ—Ä—Ç—ë–∂ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <video id="preview" autoplay playsinline></video>

  <div id="out"></div>

<script>
  const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";
  const SUPABASE_ANON_KEY = "–í–°–¢–ê–í–¨_–°–í–û–ô_ANON_KEY";

  const headers = {
    "apikey": SUPABASE_ANON_KEY,
    "Authorization": "Bearer " + SUPABASE_ANON_KEY
  };

  const out = document.getElementById("out");
  const video = document.getElementById("preview");
  const btnScan = document.getElementById("btnScan");

  let stream = null, detector = null, scanning = false;

  function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

  async function supaGet(path) {
    const res = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
    if (!res.ok) throw new Error(await res.text());
    return await res.json();
  }

  async function getOrderByBarcode(barcode) {
    const rows = await supaGet(`pieces?select=order_number&barcode=eq.${encodeURIComponent(barcode)}&limit=1`);
    return rows[0]?.order_number ? String(rows[0].order_number) : null;
  }

  async function getFirstAttachmentByOrder(orderNumber) {
    const rows = await supaGet(
      `order_attachments?select=file_name,file_url,uploaded_at`
      + `&order_number=eq.${encodeURIComponent(orderNumber)}`
      + `&order=uploaded_at.desc`
      + `&limit=1`
    );
    return rows[0] || null;
  }

  function showError(title, text) {
    out.innerHTML = `
      <div class="card">
        <b>${esc(title)}</b>
        <div class="muted" style="margin-top:8px;">${esc(text)}</div>
        <div style="margin-top:10px;">
          <button onclick="window.location.reload()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞</button>
        </div>
      </div>`;
  }

  async function handleBarcode(barcode){
    out.innerHTML = `<div class="card"><div class="muted">–ò—â—É –∑–∞–∫–∞–∑ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É ${esc(barcode)}...</div></div>`;
    try {
      const orderNumber = await getOrderByBarcode(barcode);
      if (!orderNumber) {
        showError("–ù–µ –Ω–∞–π–¥–µ–Ω–æ", "–®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ pieces.");
        return;
      }

      out.innerHTML = `<div class="card"><div class="muted">–ó–∞–∫–∞–∑ ${esc(orderNumber)} –Ω–∞–π–¥–µ–Ω. –û—Ç–∫—Ä—ã–≤–∞—é —á–µ—Ä—Ç—ë–∂...</div></div>`;
      const file = await getFirstAttachmentByOrder(orderNumber);

      if (!file || !file.file_url) {
        showError("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞", `–î–ª—è –∑–∞–∫–∞–∑–∞ ${orderNumber} –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ PDF/—Ñ–æ—Ç–æ.`);
        return;
      }

      // ‚úÖ –ê–í–¢–û–û–¢–ö–†–´–¢–ò–ï (—Å–∞–º—ã–π –Ω–∞–¥–µ–∂–Ω—ã–π —Å–ø–æ—Å–æ–± –Ω–∞ Android)
      window.location.href = file.file_url;

    } catch (e) {
      showError("–û—à–∏–±–∫–∞", String(e.message || e));
    }
  }

  async function startScan(){
    if (!("BarcodeDetector" in window)) {
      alert("–≠—Ç–æ—Ç –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç BarcodeDetector. –ò—Å–ø–æ–ª—å–∑—É–π Chrome –Ω–∞ Android.");
      return;
    }
    detector = new BarcodeDetector({ formats: ["code_128","qr_code","ean_13","ean_8"] });

    stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" }, audio: false });
    video.srcObject = stream;
    video.style.display = "block";
    btnScan.textContent = "‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å";
    scanning = true;

    const tick = async () => {
      if (!scanning) return;
      try {
        const codes = await detector.detect(video);
        if (codes && codes.length) {
          const code = (codes[0].rawValue || "").trim();
          stopScan();
          await handleBarcode(code);
          return;
        }
      } catch {}
      requestAnimationFrame(tick);
    };
    requestAnimationFrame(tick);
  }

  function stopScan(){
    scanning = false;
    btnScan.textContent = "üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å";
    video.style.display = "none";
    if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
  }

  btnScan.addEventListener("click", () => scanning ? stopScan() : startScan());
</script>
</body>
</html>

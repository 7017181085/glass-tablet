<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ü–ª–∞–Ω—à–µ—Ç ‚Äî —á–µ—Ä—Ç—ë–∂ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    button { font-size:18px; padding:12px 14px; width:100%; margin: 6px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top:12px; }
    .muted { color:#666; }
    #preview { width:100%; border-radius:12px; margin-top:12px; background:#000; }
    .big { font-size:20px; font-weight:700; }
    input { font-size:18px; padding:12px; width:100%; box-sizing:border-box; margin-top:8px; }
  </style>
</head>
<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">–ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù. –ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –≤–∫–ª—é—á–∏–ª–∞—Å—å ‚Äî –ø–æ–¥–Ω–µ—Å–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥, –ø–æ–¥–æ–∂–¥–∏ 1‚Äì2 —Å–µ–∫.</div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnStop" style="display:none;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <video id="preview" autoplay playsinline></video>

  <div class="card">
    <div class="muted">–ï—Å–ª–∏ —Å–∫–∞–Ω–µ—Ä –Ω–µ –ª–æ–≤–∏—Ç (–ø–ª–æ—Ö–æ–π —Ñ–æ–∫—É—Å/—Å–≤–µ—Ç) ‚Äî –≤—Å—Ç–∞–≤—å —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</div>
    <input id="manual" placeholder="–í—Å—Ç–∞–≤—å barcode –∏ –Ω–∞–∂–º–∏ Enter" />
  </div>

  <div id="out"></div>

  <!-- ZXing: —Å—Ç–∞–±–∏–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä –¥–ª—è Android Chrome -->
  <script type="module">
    import {
      BrowserMultiFormatReader,
      BarcodeFormat,
      DecodeHintType,
      NotFoundException
    } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

    // ====== –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ======
    const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";
    const SUPABASE_ANON_KEY = "–í–°–¢–ê–í–¨_–°–í–û–ô_ANON_KEY";

    const headers = {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    };

    const $ = (id) => document.getElementById(id);
    const out = $("out");

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

    async function supaGet(path) {
      const res = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
      if (!res.ok) throw new Error(await res.text());
      return await res.json();
    }

    async function getOrderByBarcode(barcode) {
      const rows = await supaGet(`pieces?select=order_number&barcode=eq.${encodeURIComponent(barcode)}&limit=1`);
      return rows[0]?.order_number ? String(rows[0].order_number) : null;
    }

    async function getFirstAttachmentByOrder(orderNumber) {
      const rows = await supaGet(
        `order_attachments?select=file_name,file_url,uploaded_at`
        + `&order_number=eq.${encodeURIComponent(orderNumber)}`
        + `&order=uploaded_at.desc`
        + `&limit=1`
      );
      return rows[0] || null;
    }

    function showInfo(title, text) {
      out.innerHTML = `
        <div class="card">
          <div class="big">${esc(title)}</div>
          <div class="muted" style="margin-top:8px;">${esc(text)}</div>
        </div>`;
    }

    async function openDrawingByBarcode(barcode) {
      showInfo("–ò—â—É‚Ä¶", `–®–ö: ${barcode}`);
      try {
        const orderNumber = await getOrderByBarcode(barcode);
        if (!orderNumber) {
          showInfo("–ù–µ –Ω–∞–π–¥–µ–Ω–æ", "–®—Ç—Ä–∏—Ö–∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –±–∞–∑–µ (pieces).");
          return;
        }

        const file = await getFirstAttachmentByOrder(orderNumber);
        if (!file || !file.file_url) {
          showInfo("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞", `–î–ª—è –∑–∞–∫–∞–∑–∞ ${orderNumber} –Ω–µ—Ç –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ PDF/—Ñ–æ—Ç–æ.`);
          return;
        }

        // –ù–∞–¥—ë–∂–Ω–µ–µ –≤—Å–µ–≥–æ –Ω–∞ Android: –ø–µ—Ä–µ—Ö–æ–¥ –ø–æ —Å—Å—ã–ª–∫–µ
        window.location.href = file.file_url;
      } catch (e) {
        showInfo("–û—à–∏–±–∫–∞", String(e.message || e));
      }
    }

    // ====== –°–ö–ê–ù–ï–† ZXING ======
    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [
      BarcodeFormat.CODE_128,   // –≤–∞—à –æ—Å–Ω–æ–≤–Ω–æ–π
      BarcodeFormat.EAN_13,
      BarcodeFormat.EAN_8,
      BarcodeFormat.CODE_39,
      BarcodeFormat.QR_CODE
    ]);

    const reader = new BrowserMultiFormatReader(hints, {
      delayBetweenScanAttempts: 150,   // –±—ã—Å—Ç—Ä–µ–µ –ø—ã—Ç–∞–µ—Ç—Å—è
      delayBetweenScanSuccess: 800
    });

    let active = false;

    async function start() {
      if (active) return;
      active = true;
      $("btnScan").style.display = "none";
      $("btnStop").style.display = "block";
      showInfo("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥‚Ä¶");

      try {
        // –í—ã–±–∏—Ä–∞–µ–º "–∑–∞–¥–Ω—é—é" –∫–∞–º–µ—Ä—É
        await reader.decodeFromConstraints(
          { video: { facingMode: "environment" } },
          $("preview"),
          async (result, err) => {
            if (!active) return;

            if (result) {
              const code = String(result.getText() || "").trim();
              if (code) {
                stop();
                await openDrawingByBarcode(code);
              }
            } else if (err && !(err instanceof NotFoundException)) {
              // NotFoundException = –ø—Ä–æ—Å—Ç–æ ‚Äú–µ—â—ë –Ω–µ —É–≤–∏–¥–µ–ª –∫–æ–¥‚Äù
              console.log("scan err:", err);
            }
          }
        );
      } catch (e) {
        active = false;
        $("btnScan").style.display = "block";
        $("btnStop").style.display = "none";
        showInfo("–ö–∞–º–µ—Ä–∞/—Å–∫–∞–Ω–µ—Ä –Ω–µ —Å—Ç–∞—Ä—Ç–æ–≤–∞–ª", String(e.message || e));
      }
    }

    function stop() {
      if (!active) return;
      active = false;
      try { reader.reset(); } catch {}
      $("btnScan").style.display = "block";
      $("btnStop").style.display = "none";
      showInfo("–û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ", "–ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Å–Ω–æ–≤–∞.");
    }

    $("btnScan").addEventListener("click", start);
    $("btnStop").addEventListener("click", stop);

    // –†—É—á–Ω–æ–π –≤–≤–æ–¥ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
    $("manual").addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const code = $("manual").value.trim();
        if (code) await openDrawingByBarcode(code);
      }
    });
  </script>
</body>
</html>

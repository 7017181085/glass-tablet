<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    h2 { margin: 6px 0; }
    button { font-size:18px; padding:12px 14px; width:100%; margin: 6px 0; }
    .card { border:1px solid #ddd; border-radius:12px; padding:12px; margin-top:12px; }
    .muted { color:#666; }
    .big { font-size:20px; font-weight:700; }
    input { font-size:18px; padding:12px; width:100%; box-sizing:border-box; margin-top:8px; }
    #reader { width:100%; border-radius:12px; overflow:hidden; margin-top:10px; }
    .row { display:flex; gap:10px; margin-top:8px; }
    .row button { width: 40%; }
    .row input { width: 60%; margin-top:0; }
    .mono { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, monospace; font-size: 13px; }
  </style>
</head>
<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">–ù–∞–∂–º–∏ ‚Äú–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å‚Äù ‚Üí –Ω–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ ‚Üí —á–µ—Ä—Ç—ë–∂ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.</div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnStop" style="display:none;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <div id="reader" style="display:none;"></div>

  <div class="card">
    <div class="muted">–ï—Å–ª–∏ —Å–∫–∞–Ω –Ω–µ –ª–æ–≤–∏—Ç ‚Äî –≤–≤–µ–¥–∏ —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</div>
    <div class="row">
      <input id="manual" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 0000140012" />
      <button id="btnOpen">–û—Ç–∫—Ä—ã—Ç—å</button>
    </div>
  </div>

  <div id="out"></div>

  <!-- –°–∫–∞–Ω–µ—Ä-–±–∏–±–ª–∏–æ—Ç–µ–∫–∞ —á–µ—Ä–µ–∑ —Å—Ç–∞–±–∏–ª—å–Ω—ã–π CDN (jsDelivr) -->
  <script src="https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.10/html5-qrcode.min.js"></script>

  <script>
    // ====== –ù–ê–°–¢–†–û–ô–ö–ò SUPABASE ======
    const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";
    const SUPABASE_ANON_KEY = "sb_publishable_vgoMuq7bXzlt25n3PIfmWg_MnTr9JgZ";

    const headers = {
      "apikey": SUPABASE_ANON_KEY,
      "Authorization": "Bearer " + SUPABASE_ANON_KEY
    };

    const out = document.getElementById("out");
    const readerEl = document.getElementById("reader");
    const btnScan = document.getElementById("btnScan");
    const btnStop = document.getElementById("btnStop");
    const manual = document.getElementById("manual");
    const btnOpen = document.getElementById("btnOpen");

    function esc(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
    function show(title, text){
      out.innerHTML = `
        <div class="card">
          <div class="big">${esc(title)}</div>
          <div class="mono muted" style="margin-top:8px;">${esc(text)}</div>
        </div>`;
    }

    async function supaGet(path){
      const r = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
      if(!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    // ====== "–£–ú–ù–´–ô" –ü–û–ò–°–ö –ü–û –®–¢–†–ò–•–ö–û–î–£ ======
    async function openDrawingByBarcode(raw){
      const scanned = String(raw || "");

      const candidates = [];
      // 1) –∫–∞–∫ –µ—Å—Ç—å + trim
      candidates.push(scanned);
      candidates.push(scanned.trim());

      // 2) —É–±—Ä–∞—Ç—å * (—á–∞—Å—Ç–æ —É CODE_39)
      candidates.push(scanned.replace(/\*/g, "").trim());

      // 3) —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
      const digits = scanned.replace(/\D/g, "");
      if (digits) candidates.push(digits);

      // 4) –±–µ–∑ –≤–µ–¥—É—â–∏—Ö –Ω—É–ª–µ–π
      const noLeadZeros = digits ? digits.replace(/^0+/, "") : "";
      if (noLeadZeros) candidates.push(noLeadZeros);

      // 5) –¥–æ–±–∏—Ç—å –Ω—É–ª—è–º–∏ –¥–æ —Ç–∏–ø–æ–≤—ã—Ö –¥–ª–∏–Ω (–µ—Å–ª–∏ –±–∞–∑–∞ —Ö—Ä–∞–Ω–∏—Ç —Å –≤–µ–¥—É—â–∏–º–∏ –Ω—É–ª—è–º–∏)
      if (noLeadZeros) {
        candidates.push(noLeadZeros.padStart(10, "0"));
        candidates.push(noLeadZeros.padStart(12, "0"));
        candidates.push(noLeadZeros.padStart(14, "0"));
      }

      // 6) —É–±—Ä–∞—Ç—å –ø—Ä–æ–±–µ–ª—ã –≤–Ω—É—Ç—Ä–∏ (–Ω–∞ –≤—Å—è–∫–∏–π)
      candidates.push(scanned.replace(/\s+/g, ""));

      // uniq
      const uniq = [...new Set(candidates)].filter(Boolean);

      show("–ü–æ–∏—Å–∫‚Ä¶",
        "–°–∫–∞–Ω–µ—Ä –ø—Ä–æ—á–∏—Ç–∞–ª:\n" + scanned +
        "\n\n–ü—Ä–æ–±—É—é –≤–∞—Ä–∏–∞–Ω—Ç—ã:\n" + uniq.join("\n")
      );

      let orderNumber = null;
      let usedBarcode = null;

      for (const code of uniq) {
        const p = await supaGet(
          `pieces?select=order_number,barcode&barcode=eq.${encodeURIComponent(code)}&limit=1`
        );
        if (p.length) {
          orderNumber = String(p[0].order_number);
          usedBarcode = code;
          break;
        }
      }

      if (!orderNumber) {
        show("–ù–µ –Ω–∞–π–¥–µ–Ω–æ",
          "–®—Ç—Ä–∏—Ö–∫–æ–¥ –ù–ï –Ω–∞–π–¥–µ–Ω –≤ pieces.\n\n" +
          "–°–∫–∞–Ω–µ—Ä –ø—Ä–æ—á–∏—Ç–∞–ª:\n" + scanned + "\n\n" +
          "–ü—Ä–æ–±–æ–≤–∞–ª –≤–∞—Ä–∏–∞–Ω—Ç—ã:\n" + uniq.join("\n") + "\n\n" +
          "–ü–æ–¥—Å–∫–∞–∑–∫–∞: –µ—Å–ª–∏ –≤—Ä—É—á–Ω—É—é —Ä–∞–±–æ—Ç–∞–µ—Ç, –∑–Ω–∞—á–∏—Ç –≤ –±–∞–∑–µ –¥—Ä—É–≥–æ–π —Ñ–æ—Ä–º–∞—Ç (–Ω—É–ª–∏/—Å–∏–º–≤–æ–ª—ã)."
        );
        return;
      }

      // 2) order_attachments -> file_url (—Å–∞–º—ã–π —Å–≤–µ–∂–∏–π)
      const a = await supaGet(
        `order_attachments?select=file_url,uploaded_at&order_number=eq.${encodeURIComponent(orderNumber)}&order=uploaded_at.desc&limit=1`
      );

      if(!a.length || !a[0].file_url){
        show("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞",
          "–ù–∞—à—ë–ª –ø–æ –®–ö: " + usedBarcode + "\n" +
          "–ó–∞–∫–∞–∑: " + orderNumber + "\n\n" +
          "–ù–æ PDF/—Ñ–æ—Ç–æ –ø–æ —ç—Ç–æ–º—É –∑–∞–∫–∞–∑—É –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç."
        );
        return;
      }

      show("–û—Ç–∫—Ä—ã–≤–∞—é‚Ä¶",
        "–ù–∞—à—ë–ª –ø–æ –®–ö: " + usedBarcode + "\n" +
        "–ó–∞–∫–∞–∑: " + orderNumber + "\n\n" +
        "–û—Ç–∫—Ä—ã–≤–∞—é —Ñ–∞–π–ª‚Ä¶"
      );

      window.location.href = a[0].file_url;
    }

    // ====== –°–ö–ê–ù–ï–† ======
    let html5Qr = null;
    let scanning = false;

    async function startScan(){
      if (scanning) return;

      if (typeof Html5Qrcode === "undefined"){
        show("–û—à–∏–±–∫–∞", "–°–∫–∞–Ω–µ—Ä –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è (Html5Qrcode undefined). –ü—Ä–æ–≤–µ—Ä—å –∏–Ω—Ç–µ—Ä–Ω–µ—Ç –∏ –æ–±–Ω–æ–≤–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—É.");
        return;
      }

      scanning = true;
      btnScan.style.display = "none";
      btnStop.style.display = "block";
      readerEl.style.display = "block";
      show("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥‚Ä¶");

      html5Qr = new Html5Qrcode("reader");

      const config = {
        fps: 15,
        qrbox: { width: 320, height: 320 },
        formatsToSupport: [
          Html5QrcodeSupportedFormats.CODE_128,
          Html5QrcodeSupportedFormats.EAN_13,
          Html5QrcodeSupportedFormats.EAN_8,
          Html5QrcodeSupportedFormats.CODE_39,
          Html5QrcodeSupportedFormats.QR_CODE
        ]
      };

      try{
        await html5Qr.start(
          { facingMode: "environment" },
          config,
          async (decodedText) => {
            const code = String(decodedText || "").trim();
            if (!code) return;
            await stopScan();
            await openDrawingByBarcode(code);
          },
          () => {}
        );
      } catch(e){
        scanning = false;
        btnScan.style.display = "block";
        btnStop.style.display = "none";
        readerEl.style.display = "none";
        show("–û—à–∏–±–∫–∞ –∫–∞–º–µ—Ä—ã", String(e && e.message ? e.message : e));
      }
    }

    async function stopScan(){
      if (!scanning) return;
      scanning = false;

      try{
        if (html5Qr) {
          await html5Qr.stop();
          await html5Qr.clear();
        }
      } catch {}
      html5Qr = null;

      btnScan.style.display = "block";
      btnStop.style.display = "none";
      readerEl.style.display = "none";
    }

    btnScan.addEventListener("click", startScan);
    btnStop.addEventListener("click", stopScan);

    btnOpen.addEventListener("click", async () => {
      const code = manual.value.trim();
      if (code) await openDrawingByBarcode(code);
    });

    manual.addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const code = manual.value.trim();
        if (code) await openDrawingByBarcode(code);
      }
    });
  </script>
</body>
</html>

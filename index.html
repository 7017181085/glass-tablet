<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</title>

  <style>
    body { font-family: Arial, sans-serif; margin: 12px; }
    h2 { margin-bottom: 6px; }
    button {
      font-size: 18px;
      padding: 14px;
      width: 100%;
      margin: 8px 0;
    }
    video {
      width: 100%;
      border-radius: 12px;
      background: #000;
      margin-top: 10px;
    }
    .card {
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 12px;
      margin-top: 12px;
    }
    .muted { color: #666; }
    .big { font-size: 20px; font-weight: bold; }
    input {
      font-size: 18px;
      padding: 12px;
      width: 100%;
      box-sizing: border-box;
      margin-top: 8px;
    }
  </style>
</head>

<body>
  <h2>–ß–µ—Ä—Ç—ë–∂ –∑–∞–∫–∞–∑–∞ –ø–æ —à—Ç—Ä–∏—Ö–∫–æ–¥—É</h2>
  <div class="muted">
    –ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥ —Å—Ç–µ–∫–ª–∞ ‚Äî PDF / —Ñ–æ—Ç–æ –æ—Ç–∫—Ä–æ–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
  </div>

  <button id="btnScan">üì∑ –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
  <button id="btnStop" style="display:none;">‚õî –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å</button>

  <video id="preview" autoplay playsinline></video>

  <div class="card">
    <div class="muted">–ï—Å–ª–∏ –∫–∞–º–µ—Ä–∞ –Ω–µ –ª–æ–≤–∏—Ç ‚Äî –≤—Å—Ç–∞–≤—å —à—Ç—Ä–∏—Ö–∫–æ–¥ –≤—Ä—É—á–Ω—É—é:</div>
    <input id="manual" placeholder="–í—Å—Ç–∞–≤—å —à—Ç—Ä–∏—Ö–∫–æ–¥ –∏ –Ω–∞–∂–º–∏ Enter" />
  </div>

  <div id="out"></div>

  <script type="module">
    import {
      BrowserMultiFormatReader,
      BarcodeFormat,
      DecodeHintType,
      NotFoundException
    } from "https://cdn.jsdelivr.net/npm/@zxing/browser@0.1.5/+esm";

    /* ================= –ù–ê–°–¢–†–û–ô–ö–ò ================= */

    const SUPABASE_URL = "https://mfvxrikcsdczzspnjrhi.supabase.co";

    const SUPABASE_ANON_KEY =
      "sb_publishable_vgoMuq7bXzlt25n3PIfmWg_MnTr9JgZ";

    const headers = {
      apikey: SUPABASE_ANON_KEY,
      Authorization: "Bearer " + SUPABASE_ANON_KEY
    };

    /* ================= –£–¢–ò–õ–ò–¢–´ ================= */

    const $ = (id) => document.getElementById(id);
    const out = $("out");

    function show(title, text) {
      out.innerHTML = `
        <div class="card">
          <div class="big">${title}</div>
          <div class="muted" style="margin-top:8px;">${text}</div>
        </div>`;
    }

    async function supa(path) {
      const r = await fetch(SUPABASE_URL + "/rest/v1/" + path, { headers });
      if (!r.ok) throw new Error(await r.text());
      return await r.json();
    }

    async function openByBarcode(barcode) {
      show("–ü–æ–∏—Å–∫‚Ä¶", "–®—Ç—Ä–∏—Ö–∫–æ–¥: " + barcode);

      const piece = await supa(
        `pieces?select=order_number&barcode=eq.${encodeURIComponent(barcode)}&limit=1`
      );

      if (!piece.length) {
        show("–ù–µ –Ω–∞–π–¥–µ–Ω–æ", "–®—Ç—Ä–∏—Ö–∫–æ–¥ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –±–∞–∑–µ");
        return;
      }

      const order = piece[0].order_number;

      const files = await supa(
        `order_attachments?select=file_url&order_number=eq.${order}&limit=1`
      );

      if (!files.length) {
        show("–ù–µ—Ç —á–µ—Ä—Ç–µ–∂–∞", "–î–ª—è –∑–∞–∫–∞–∑–∞ " + order + " –Ω–µ—Ç PDF / —Ñ–æ—Ç–æ");
        return;
      }

      window.location.href = files[0].file_url;
    }

    /* ================= –°–ö–ê–ù–ï–† ================= */

    const hints = new Map();
    hints.set(DecodeHintType.POSSIBLE_FORMATS, [
      BarcodeFormat.CODE_128,
      BarcodeFormat.EAN_13,
      BarcodeFormat.EAN_8,
      BarcodeFormat.CODE_39,
      BarcodeFormat.QR_CODE
    ]);

    const reader = new BrowserMultiFormatReader(hints, {
      delayBetweenScanAttempts: 150
    });

    let active = false;

    async function start() {
      if (active) return;
      active = true;

      $("btnScan").style.display = "none";
      $("btnStop").style.display = "block";
      show("–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–ù–∞–≤–µ–¥–∏ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö–∫–æ–¥‚Ä¶");

      await reader.decodeFromConstraints(
        { video: { facingMode: "environment" } },
        $("preview"),
        async (result, err) => {
          if (!active) return;
          if (result) {
            const code = result.getText();
            stop();
            await openByBarcode(code);
          }
        }
      );
    }

    function stop() {
      active = false;
      reader.reset();
      $("btnScan").style.display = "block";
      $("btnStop").style.display = "none";
    }

    $("btnScan").onclick = start;
    $("btnStop").onclick = stop;

    $("manual").addEventListener("keydown", async (e) => {
      if (e.key === "Enter") {
        const code = $("manual").value.trim();
        if (code) await openByBarcode(code);
      }
    });
  </script>
</body>
</html>
